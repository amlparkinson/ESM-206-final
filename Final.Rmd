---
title: "Fall 2019 Final Exam"
author: "Anne-Marie Parkinson"
date: "December 4, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = F,
  message = FALSE,
  warning = FALSE)
```


```{r}
# load packages

library(tidyverse)
library(dplyr)
library(janitor)
library(kableExtra)
library(grid)
library(stargazer)

```

### Task 1: Predicting Penguin Mass


so use multiple linear regression to predict mass using species + sex + flipper length

steps: visualize data for correlations
make model (with diff combos)
check assumptions
```{r}
# load data and remove NA's
penguin <- read_csv("lter_penguin_species.csv") %>% 
  drop_na(body_mass_g) %>% 
  drop_na(flipper_length_mm) %>% 
  drop_na(sex) %>% 
  filter (sex != ".")

```

```{r}

# visualize data
penguin_sub <- penguin %>% 
  select(body_mass_g, species, flipper_length_mm, sex)

ggplot(penguin_sub, aes(x=flipper_length_mm, y=body_mass_g)) +
  geom_point(aes(color=fct_rev(species))) +
  facet_wrap(~sex) +
  labs(x = "\nFlipper Length (mm)", 
       y = "Body Mass (g)\n", 
       title = "Weight and Flipper Length\n of Three Antarctic Penguin Species") +
  theme_bw() +
  scale_color_discrete(name="Species", 
                       labels=c("Gentoo Penguin (Pygoscelis papua)",
                                'Chinstrap Penguin (Pygoscelis antarctica)',
                                "Adelie Penguin (Pygoscelis adeliae)")) +
  theme(legend.title.align=0.5, 
        plot.title = element_text(hjust=0.5),
        panel.spacing=unit(2, "lines")) +
  scale_x_continuous(lim=c(150, 250), 
                     expand=c(0,0),
                     breaks=seq(150, 250, by=50)) +
  scale_y_continuous(lim=c(2500, 6500), 
                     expand=c(0,0),
                     breaks=seq(3000, 6500, by=1000))





```
***Figure 1:** Data: Palmer Station LTER.*

General trends from Figure 1:

- Male penguins appear to have higher body mass and slightly longer flipper lengths than females across all three species. 
- Gentoo penguins have the highest body mass and longest flipper length than Chinstrap and Adelie penguins. 


***Table 1:** text here*
```{r, results='asis', include = F}
#Multiple linear regression model 

# model trials --------------------------------------------------

mass_model1 <- lm(body_mass_g ~ species + flipper_length_mm + sex, data=penguin)
summary(mass_model1)

mass_model2 <- lm(body_mass_g ~ flipper_length_mm + sex, data=penguin) 
summary(mass_model2)

mass_model3 <- lm(body_mass_g ~ species + flipper_length_mm, data=penguin)
summary(mass_model3)

# compare model AICs

AIC (mass_model1) #4740 --> lowest AIC
AIC (mass_model2) #4862
AIC (mass_model3) #4895

# check assumptions (residual normality and homoscedasticity)

plot(mass_model1)

# statement about how the model passes the assumptions here #########

#table to report model results (using stargazer)

stargazer(mass_model1, type="html")



```



```{r, include = F}
# G:	Use the model, predict the masses 
mass_model1

intercept = -365.82
flipper_length = 20.02


```


















### Task 2: Smoking effects on baby birth weight

```{r}
# load data and only keep tpounds, lowbw, and smoke columns

birthweights <- read_csv('nc_birthweights.csv') %>% 
  select (tpounds, lowbw, smoke) %>% 
  drop_na(smoke)

```

```{r}
# table: Does the proportion of babies born at “low birth weight” differ depending on whether the mother smoked or did not smoke during pregnancy

# step 1: create sub data

birthweights_table_data <- birthweights %>% 
  group_by(smoke) %>% 
  count(lowbw) %>% 
  mutate(low_birth_weight = case_when( 
         lowbw == 1 ~ "Yes",
         lowbw == 0 ~ "No")) %>% 
  mutate("Mother Smoke?" = case_when(
    smoke == 1 ~"Yes",
    smoke == 0 ~"No"
  )) %>% 
  ungroup(smoke) %>% 
  select(-lowbw, -smoke)

# step 2 create contigency  table

birthweights_table_counts <- birthweights_table_data %>% 
  pivot_wider(names_from = low_birth_weight, values_from = n) 

birthweights_table_proportions <- birthweights_table_counts %>% 
  adorn_percentages(denominator = "row") %>% 
  adorn_pct_formatting(digits=1) %>% 
  adorn_ns(position = "front")

# step 3: R markdown friendly contigency table with counts and proportions

birthweights_table_proportions %>% 
  kable (col.names = c("Mother Smoke?", "No", "Yes")) %>%
  add_header_above(c(" "= 1, "Low Birthweight?"=2)) %>% 
  #add_header_above(c("North Carolina babies: Does mother smoking affect baby's birthweight?"=3)) %>% 
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"), 
    full_width=F,
    position="center") %>% 
  column_spec(1, width='4cm') %>%  #control column 1's row width
  column_spec(2, width="8em") %>% 
  column_spec(3, width="8em")


```

```{r, include = F}
# statistically significant difference between the proportion of babies born at low birth weights for smoking vs. non-smoking mothers? 

# H null: there is no difference in birthweights of babies from mothers who did and did not smoke
# H alt : there is a difference in birthweights of babies from mothers who did and did not smoke

# step 1: get cocntigency table of just counts
birthweight_counts <- birthweights_table_counts %>% 
  column_to_rownames('Mother Smoke?')           

# step 2: run chi-square test
birthweights_chi <- chisq.test(birthweight_counts)
birthweights_chi

# p = 0.2696
```

A Pearson's chi-squared test was performed to examine whether or not babies with low birthweights are independent of having mothers who smoked during pregnancy. The results from our test found that babies with low bithweights are independent of mothers smoking during pregnancy ($\chi$^2^(`r birthweights_chi$parameter`) = `r round(birthweights_chi$statistic,2)`, *p* = `r round(birthweights_chi$p.value,2)`). 

To improve future surveys, researchers might consider changing the "smoking during pregnancy" category from binomial (yes or no) to a ordinal response (frequently, sometimes, rarely, never). Some women might have smoked once or twice throughout their pregnancy, while others might have smoked every day, or some other frequency. Mothers who smoked once or twice may not have as much of an effect on their babies birthweight than mothers who smoked frequently, so researchers would want to distinguish between these differences if there are any.


### Task 3: Visualizing UCSB campus profiles

```{r, include = F}
ucsb <- read_csv('ucsb_campus_profiles.csv') %>% 
  pivot_longer('2018 - 2019' : '2008 - 2009',
               names_to = 'year',
               values_to = 'value') %>% 
  clean_names()
```



```{r, include = F}
# for now, explore what relationship to explore
# subdata: combine groups and remove other/unknown

ucsb_ethnicity_combined <- ucsb %>% 
  group_by(ethnicity_domestic_enrollment,year) %>% 
  summarise(enrollment = sum(value, na.rm=T)) %>% 
  ungroup(ethnicity_domestic_enrollment) %>% 
  mutate (ethnicity_domestic_enrollment = case_when(
    ethnicity_domestic_enrollment %in% 'American Indian / Alaskan'  ~ 'American Indian/Alaskan', 
    ethnicity_domestic_enrollment %in% c("Asian / Pacific Islander", "Filipino" ) ~ "Asian/Pacific Islander", 
    ethnicity_domestic_enrollment %in% "Black / African American" ~ "Black/African American",
    ethnicity_domestic_enrollment %in% c("Chicano", "Latino") ~ "Hispanic",
    ethnicity_domestic_enrollment %in% "E. Indian / Pakistani" ~ "E.Indian/Pakistani",
    ethnicity_domestic_enrollment %in% "White" ~ "White",
    ethnicity_domestic_enrollment %in% c("Other", "Unknown") ~ "Other"
  )) %>% 
  filter (ethnicity_domestic_enrollment != "Other")

# keep top 5 most enrolled ethnicity groups
ucsb_ethnicity_top <- ucsb_ethnicity_combined %>% 
  group_by(ethnicity_domestic_enrollment) %>% 
  head(5, enrollment,add_rownames=T)

#plot

ggplot (new, aes(x=year, y=enrollment)) +
  geom_point (aes(color=ethnicity_domestic_enrollment)) 
  
```


### Task 4: Purple urchins on the Santa Barbara coast

```{r, include = F}
# load data and modify so only have purple urchin observations in control treatments 

urchin <- read_csv('sbc_lter_urchins.csv') 
urchin <-  urchin %>% 
  clean_names() %>% 
  filter (common_name == "Purple Urchin") %>% 
  filter (treatment == "CONTROL") %>% 
  uncount(count) %>% 
  select (year, site, size) %>% 
  mutate(site = case_when(
    site %in% c("CARP") ~ "Carpinteria" ,
    site %in% c("IVEE") ~ "Isla Vista",
    site %in% c("AQUE") ~ "Arroyo Quemado",
    site %in% c("MOHK") ~ "Mohawk", 
    site %in% c("NAPL") ~ "Naples")) %>% 
  mutate(year=as.character(year))

```

```{r, include = F}

# summary statistics for urchin sizes at the 5 different sites

urchin_stats <- urchin %>% 
  group_by(site) %>% 
  summarize (mean = mean(size, na.rm=T),
             sd = sd(size, na.rm=T),
             se = sd((size) / sqrt(n()), na.rm=T),
             sample_size = n())
# kable of urchin stats

urchin_stats %>% 
  kable (col.names = c("Site", "Mean", "Standard Deviation", "Standard Error", "Sample Size"),
         digits=2) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"), 
    full_width=T,
    position="center") 


```
maybe choose a different graph? -> yes ,make a graph with measures of uncertainty (sd, se)
```{r, include = F}
# exploratory graphs of purple urchin size distributions at each site

ggplot (urchin, aes(x=size)) +
  geom_density(aes(fill=site), show.legend=F) +
  labs ( x= '\nSize (?)', 
         y = 'Density\n', 
         title="Sampling distribution of purple urchins",
         subtitle = "2008-2018\n") +
  scale_x_continuous(expand = c(0,0),
                     lim = c(0,10),
                     breaks = seq(0,10, by=2)) +
  scale_y_continuous(expand = c(0,0)) +
  theme_bw() +
  facet_wrap(~site, scales="free_x") +
  theme(plot.title = element_text(hjust=0.5),
        panel.spacing=unit(2, "lines"),
        plot.subtitle = element_text(hjust=0.5))



```



Observations of exploratory graphs:

- Distribution of sizes appears to be normal for all five sites.
- There is a large sample size for all sites, so it is unlikely that all urchins at the sites fall within these bounds. These gaps in the graph are likely due to sampling error --> check metadata

```{r, include = F}
# is there a significant difference in mean purple urchin size in control treatments at the 5 sites

# H null: there is no significant difference in mean purple urchin size in control treatments at the 5 sites
# H alt: there is a significant difference in mean purple urchin size in control treatments at the 5 sites

# anova
urchin_aov <- aov(size ~ site, data=urchin)
summary(urchin_aov)
# p<2e-16

# tukey
urchin_tukey <- TukeyHSD(urchin_aov)
urchin_tukey

# results: all sites have a significant difference except for 

# To report your one-way ANOVA, need to unlist the outcomes isla vista and carpenteria

urchin_outputs <- unlist(summary(urchin_aov))
urchin_outputs

# Create a data frame of Tukey to reference p-values through in-line referencing

df <- data.frame(urchin_tukey$site)
df
```

To determine whether or not there is a difference in total mean sizes for purple urchins (*Strongylocentrotus purpuratus*) found in five different sites along the Santa Barbara coast, a one-way ANOVA test was performed. The results  F(`r urchin_outputs[1]`, `r urchin_outputs[2]`) = `r round(urchin_outputs[7],2)`, *p* = `r round(urchin_outputs[9],3)`) indicate that there is a significant difference between at least two of the mean sizes for purple urchins in different sites A Tukey's HSD post-hoc test was performed to determine which sites had significant differences between total mean sizes. The results show that there is a significant difference in all but one pairwise comparison: total mean sizes between purple urchins in Isla Vista (`r round(urchin_stats$mean[3], 2)`g $\pm$ `r round(urchin_stats$sd[3], 2)`g)(mean $\pm$ SD) and Carpinteria (`r round(urchin_stats$mean[2], 2)`g $\pm$ `r round(urchin_stats$sd[2], 2)`g)(mean $\pm$ SD) (*p* = `r round(df$p.adj[5],3)`). 


mohawk: (`r round(urchin_stats$mean[4], 2)`g $\pm$ `r round(urchin_stats$sd[4], 2)`g) 
naples: (`r round(urchin_stats$mean[5], 2)`g $\pm$ `r round(urchin_stats$sd[5], 2)`g)
arroyo Quemado (`r round(urchin_stats$mean[1], 2)`g $\pm$ `r round(urchin_stats$sd[1], 2)`g)

The actual differences in mean weights between channel types was 1.78 grams between pools and cascades and 1.84 grams between side channels and cascades. These differences were significantly lower than the difference between pools and side channles, which was 3.62 grams (about 50% higher than the other mean differences). 







